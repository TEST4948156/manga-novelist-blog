<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>功能完善测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .feature-section {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .feature-title {
            color: #2d3748;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        .test-item {
            background: #f8fafc;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 4px solid #48bb78;
        }
        .test-item.warning {
            border-left-color: #ed8936;
        }
        .test-item.error {
            border-left-color: #e53e3e;
        }
        button {
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #5a67d8;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-size: 14px;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
        }
        .activity-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .activity-icon {
            font-size: 1.2rem;
        }
        .activity-text {
            flex: 1;
            font-size: 14px;
        }
        .activity-time {
            font-size: 12px;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🎯 功能完善测试</h1>
        <p>测试所有新增和修改的功能</p>
    </div>

    <!-- 删除逻辑测试 -->
    <div class="test-container">
        <div class="feature-section">
            <h2 class="feature-title">🗑️ 删除逻辑测试</h2>
            <div class="test-item">
                <strong>测试内容：</strong>编辑时直接删除，删除按钮时询问
            </div>
            <div class="test-item warning">
                <strong>测试方法：</strong>
                <ol>
                    <li>在主应用中创建一个测试作品</li>
                    <li>点击"编辑"按钮 - 应该直接删除并进入编辑模式</li>
                    <li>创建另一个作品，点击"删除"按钮 - 应该弹出确认对话框</li>
                </ol>
            </div>
            <button onclick="window.open('http://localhost:5173', '_blank')">打开主应用测试</button>
        </div>
    </div>

    <!-- 作品关联测试 -->
    <div class="test-container">
        <div class="feature-section">
            <h2 class="feature-title">📚 作品关联测试</h2>
            <div class="test-item">
                <strong>测试内容：</strong>角色库和故事档案关联到作品集
            </div>
            <div class="test-item warning">
                <strong>测试方法：</strong>
                <ol>
                    <li>先在作品集中创建几个作品</li>
                    <li>进入角色库，创建角色时选择关联作品</li>
                    <li>进入故事档案，创建档案时选择关联作品</li>
                    <li>查看角色和档案卡片是否显示关联的作品</li>
                </ol>
            </div>
            <button onclick="testWorkRelation()">测试作品关联功能</button>
            <div id="relationResult"></div>
        </div>
    </div>

    <!-- 动态显示测试 -->
    <div class="test-container">
        <div class="feature-section">
            <h2 class="feature-title">📊 动态显示测试</h2>
            <div class="test-item">
                <strong>测试内容：</strong>只显示发表作品和点赞，陌生人点赞优化显示
            </div>
            <button onclick="loadActivities()">加载最新动态</button>
            <button onclick="testLikeActivity()">测试点赞动态</button>
            <div id="activitiesResult"></div>
            <div id="activitiesList"></div>
        </div>
    </div>

    <!-- AI续写测试 -->
    <div class="test-container">
        <div class="feature-section">
            <h2 class="feature-title">🤖 AI续写测试</h2>
            <div class="test-item">
                <strong>测试内容：</strong>创作时的AI续写助手功能
            </div>
            <div class="test-item warning">
                <strong>测试方法：</strong>
                <ol>
                    <li>在主应用中点击"写新文章"</li>
                    <li>输入一些内容后点击"🤖 AI续写助手"</li>
                    <li>尝试不同的续写风格</li>
                    <li>测试续写内容的应用功能</li>
                </ol>
            </div>
            <button onclick="window.open('test-ai-continue.html', '_blank')">打开AI续写测试页面</button>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3001/api';

        // 测试作品关联功能
        async function testWorkRelation() {
            const resultDiv = document.getElementById('relationResult');
            resultDiv.innerHTML = '<div class="result info">正在测试作品关联功能...</div>';

            try {
                // 获取作品列表
                const response = await fetch(`${API_BASE_URL}/works`);
                const works = await response.json();
                
                resultDiv.innerHTML = `
                    <div class="result success">
                        ✅ 作品关联功能测试通过<br>
                        当前可关联的作品数量: ${works.length}<br>
                        作品列表: ${works.map(w => w.title).join(', ')}
                    </div>
                `;
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">❌ 作品关联测试失败: ${error.message}</div>`;
            }
        }

        // 加载最新动态
        async function loadActivities() {
            const resultDiv = document.getElementById('activitiesResult');
            const listDiv = document.getElementById('activitiesList');
            
            resultDiv.innerHTML = '<div class="result info">正在加载最新动态...</div>';
            
            try {
                const response = await fetch(`${API_BASE_URL}/activities?limit=10`);
                const activities = await response.json();
                
                resultDiv.innerHTML = `<div class="result success">✅ 成功加载 ${activities.length} 条动态记录</div>`;
                
                if (activities.length === 0) {
                    listDiv.innerHTML = '<div class="activity-item"><div class="activity-text">暂无动态记录</div></div>';
                } else {
                    listDiv.innerHTML = activities.map(activity => `
                        <div class="activity-item">
                            <span class="activity-icon">${getActivityIcon(activity.type)}</span>
                            <span class="activity-text">${activity.description}</span>
                            <span class="activity-time">${formatRelativeTime(activity.created_at)}</span>
                        </div>
                    `).join('');
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">❌ 加载动态失败: ${error.message}</div>`;
            }
        }

        // 测试点赞动态
        async function testLikeActivity() {
            const resultDiv = document.getElementById('activitiesResult');
            
            try {
                // 先获取作品列表
                const worksResponse = await fetch(`${API_BASE_URL}/works`);
                const works = await worksResponse.json();
                
                if (works.length === 0) {
                    resultDiv.innerHTML = '<div class="result error">❌ 没有可点赞的作品，请先创建作品</div>';
                    return;
                }

                // 随机选择一个作品进行点赞
                const randomWork = works[Math.floor(Math.random() * works.length)];
                
                const likeResponse = await fetch(`${API_BASE_URL}/works/${randomWork.id}/like`, {
                    method: 'POST'
                });
                
                if (likeResponse.ok) {
                    resultDiv.innerHTML = `<div class="result success">✅ 成功为作品《${randomWork.title}》点赞，请查看动态更新</div>`;
                    // 自动刷新动态
                    setTimeout(loadActivities, 1000);
                } else {
                    const error = await likeResponse.json();
                    resultDiv.innerHTML = `<div class="result info">ℹ️ ${error.error}</div>`;
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">❌ 点赞测试失败: ${error.message}</div>`;
            }
        }

        // 获取活动类型图标
        function getActivityIcon(type) {
            const icons = {
                create: '📝',
                like: '❤️'
            };
            return icons[type] || '📌';
        }

        // 格式化相对时间
        function formatRelativeTime(dateString) {
            const now = new Date();
            const date = new Date(dateString);
            const diffInSeconds = Math.floor((now.getTime() - date.getTime()) / 1000);
            
            if (diffInSeconds < 60) {
                return '刚刚';
            } else if (diffInSeconds < 3600) {
                const minutes = Math.floor(diffInSeconds / 60);
                return `${minutes}分钟前`;
            } else if (diffInSeconds < 86400) {
                const hours = Math.floor(diffInSeconds / 3600);
                return `${hours}小时前`;
            } else {
                const days = Math.floor(diffInSeconds / 86400);
                return `${days}天前`;
            }
        }

        // 页面加载时自动加载动态
        window.onload = function() {
            console.log('功能测试页面已加载');
            loadActivities();
        };
    </script>
</body>
</html>
